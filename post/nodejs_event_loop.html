<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>[Черновик] Попытка объяснить event-loop</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="stylesheet" href="/static/a11y-light.css"><style>* {
      --typography-spacing-vertical: 0.75rem !important;
      --font-size: 20px;
    }

    .header-anchor {
      color: var(--h1-color);
      text-decoration: none;
    }

    p {
      --color: #2f3940 !important;
    }</style></head><body><main class="container"><div><nav><ul><li><hgroup><h3>Технический блог Артура</h3><h6>IT и музыкантсво</h6></hgroup></li></ul><ul><li><a href="/">Главная</a></li><li><a href="https://github.com/ArturAralin" target="_blank">GitHub</a></li></ul></nav></div><div class="grid"><div><h1 id="%D1%8D%D1%82%D0%BE-%D1%87%D0%B5%D1%80%D0%BD%D0%BE%D0%B2%D0%B8%D0%BA.-%D1%80%D0%B0%D0%BD%D0%BE-%D0%B5%D1%89%D0%B5.-%D0%BB%D1%83%D1%87%D1%88%D0%B5-%D0%BF%D0%BE%D1%81%D0%BC%D0%BE%D1%82%D1%80%D0%B8-%D0%BC%D0%B5%D0%BC%D1%8B-%D1%81-%D0%BA%D0%BE%D1%82%D0%B0%D0%BC%D0%B8" tabindex="-1"><a class="header-anchor" href="#%D1%8D%D1%82%D0%BE-%D1%87%D0%B5%D1%80%D0%BD%D0%BE%D0%B2%D0%B8%D0%BA.-%D1%80%D0%B0%D0%BD%D0%BE-%D0%B5%D1%89%D0%B5.-%D0%BB%D1%83%D1%87%D1%88%D0%B5-%D0%BF%D0%BE%D1%81%D0%BC%D0%BE%D1%82%D1%80%D0%B8-%D0%BC%D0%B5%D0%BC%D1%8B-%D1%81-%D0%BA%D0%BE%D1%82%D0%B0%D0%BC%D0%B8"><span><strong>ЭТО ЧЕРНОВИК. Рано еще. <a href="https://www.yandex.ru/images/search?text=%D0%BC%D0%B5%D0%BC%20%D1%81%20%D0%BA%D0%BE%D1%82%D0%B0%D0%BC%D0%B8">Лучше посмотри мемы с котами</a></strong></span></a></h1><h1 id="node-event-loop-%D0%B4%D0%BB%D1%8F-%D1%81%D0%B0%D0%BC%D1%8B%D1%85-%D0%BC%D0%B0%D0%BB%D0%B5%D0%BD%D1%8C%D0%BA%D0%B8%D1%85-%D0%B8-%D1%82%D1%83%D0%BF%D1%8B%D1%85" tabindex="-1"><a class="header-anchor" href="#node-event-loop-%D0%B4%D0%BB%D1%8F-%D1%81%D0%B0%D0%BC%D1%8B%D1%85-%D0%BC%D0%B0%D0%BB%D0%B5%D0%BD%D1%8C%D0%BA%D0%B8%D1%85-%D0%B8-%D1%82%D1%83%D0%BF%D1%8B%D1%85"><span>node event-loop для самых маленьких и тупых</span></a></h1><p>Я у мамы стал совсем большой и дорос до того, что уже сам провожу технические собеседования по NodeJS. Одним из важных факторов оценки знаний кандидата я считаю понимание прицнипов работы NodeJS. Ох, чего мне только там не рассказывали. Возможно, я уже услышал все комбинации слов: очередь, таска, промис и ивент луп. В самом деле, концепция кооперативной многозадачности (aka event-loop) не очень проста, но в этом посте я постараюсь на пальцах объяснить общую идею того, как это работает.</p><h1 id="%D0%BA%D0%BE%D0%B4!" tabindex="-1"><a class="header-anchor" href="#%D0%BA%D0%BE%D0%B4!"><span>Код!</span></a></h1><p>Имеется нехитрый обработчик http запросов, который для простоты понимания выполняется за 100 миллисекунд. Уточню, что я имею в виду то, что 100 миллисекунд это время от начала открытия сетевого соединения до момента закрытия этого соединения. <code>Db.getUserById</code> это запрос в базу данных, которая способна асинхронно обрабатывать запросы.</p><pre><code class="language-javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-title function_">app</span>();

app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/users/:id&#x27;</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Db</span>.<span class="hljs-title function_">getUserById</span>(req.<span class="hljs-property">params</span>.<span class="hljs-property">id</span>);

  res.<span class="hljs-title function_">json</span>({ user });
});

express.<span class="hljs-title function_">listen</span>(<span class="hljs-number">8080</span>);
</code></pre><p>Клиентский тоже не хитрый. Функция <code>request</code> принимает идентификатор пользователя, делает http запрос и выводит на экран время, которое занял запрос. Функция <code>test</code> запускает два запроса паралельно, дожидается ответа от обоих запросов и выводит время, которое заняли запросы.</p><pre><code class="language-javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">request</span>(<span class="hljs-params">id</span>) {
  <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();

  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`http://localhost:8080/users/<span class="hljs-subst">${id}</span>`</span>);

  <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">text</span>();

  <span class="hljs-keyword">const</span> elapsed = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - now;

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Request <span class="hljs-subst">${id}</span> elapsed time: <span class="hljs-subst">${elapsed}</span>`</span>);
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();

  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
    <span class="hljs-title function_">request</span>(<span class="hljs-number">10</span>),
    <span class="hljs-title function_">request</span>(<span class="hljs-number">20</span>),
  ]);

  <span class="hljs-keyword">const</span> elapsed = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - now;

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Total elapsed time: <span class="hljs-subst">${elapsed}</span>`</span>);
}

<span class="hljs-title function_">test</span>();
</code></pre><h1 id="%D0%B2%D0%BE%D0%BF%D1%80%D0%BE%D1%81%D1%8B!" tabindex="-1"><a class="header-anchor" href="#%D0%B2%D0%BE%D0%BF%D1%80%D0%BE%D1%81%D1%8B!"><span>Вопросы!</span></a></h1><ul><li>За какое время выполнится один запрос?</li><li>За какое время выпонятся оба запроса?</li><li>Почему так происходит?</li></ul><h1 id="%D0%B0%D0%BD%D0%B0%D0%BB%D0%BE%D0%B3%D0%B8%D1%8F-%D0%B8-%D1%82%D0%B5%D0%B0%D1%82%D1%80" tabindex="-1"><a class="header-anchor" href="#%D0%B0%D0%BD%D0%B0%D0%BB%D0%BE%D0%B3%D0%B8%D1%8F-%D0%B8-%D1%82%D0%B5%D0%B0%D1%82%D1%80"><span>Аналогия и театр</span></a></h1><p>Я бы мог устроить душный разгон про очереди, тики, микро и макро таски, колбеки и все прочее, но я приведу условный пример из жизни, а потом переложу его на те термины и процессы, которые происходят в NodeJs.</p><h2 id="%D1%81%D1%8E%D0%B6%D0%B5%D1%82-%D0%B8-%D0%B4%D0%B5%D0%B9%D1%81%D1%82%D0%B2%D1%83%D1%8E%D1%89%D0%B8%D0%B5-%D0%BB%D0%B8%D1%86%D0%B0" tabindex="-1"><a class="header-anchor" href="#%D1%81%D1%8E%D0%B6%D0%B5%D1%82-%D0%B8-%D0%B4%D0%B5%D0%B9%D1%81%D1%82%D0%B2%D1%83%D1%8E%D1%89%D0%B8%D0%B5-%D0%BB%D0%B8%D1%86%D0%B0"><span>Сюжет и действующие лица</span></a></h2><p>Начальник отдела кадров - Сергей Базоданнов, его секретарь - Таня Ивентлуповой и два брата Реквестовы Петя и Ваня.</p><p>Петя и Ваня Реквестовы хотят устроиться в компанию. Они заполнили свои анкеты и отправились лично отнести их в компанию.</p><h2 id="%D1%81%D1%86%D0%B5%D0%BD%D0%B0-%D0%BF%D0%B5%D1%80%D0%B2%D0%B0%D1%8F.-%D0%BF%D0%BE%D0%B4%D0%B0%D1%87%D0%B0-%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%BE%D0%B2" tabindex="-1"><a class="header-anchor" href="#%D1%81%D1%86%D0%B5%D0%BD%D0%B0-%D0%BF%D0%B5%D1%80%D0%B2%D0%B0%D1%8F.-%D0%BF%D0%BE%D0%B4%D0%B0%D1%87%D0%B0-%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%BE%D0%B2"><span>Сцена первая. Подача документов</span></a></h2><p>В компании Петю и Ваню отправили к секретарю - Тане Ивентлуповой. Таня, в свойственной ей манере, увидев перед собой двух ярых кандидатов попросила встать их в очередь потому, что она одна и не может проверить и принять две анкеты одновременно. Петя и Ваня, не смотря на то, что пришли одовременно выстроились в очередь и по очереди отдают свои анкеты Тане. Таня в порядке очереди приняла анкеты, завела себе в ежедневнике задачи и сказала Пете и Ване, что сделает колбек (она так перезвонить называет), когда начальник посмотрим анкеты. Радостные Петя и Ваня уходят домой ждать, когда Таня сделаем им колбек.</p><h2 id="%D1%81%D1%86%D0%B5%D0%BD%D0%B0-%D0%B2%D1%82%D0%BE%D1%80%D0%B0%D1%8F.-%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D1%8B-%D0%B8-%D0%BD%D0%B0%D1%87%D0%B0%D0%BB%D1%8C%D0%BD%D0%B8%D0%BA" tabindex="-1"><a class="header-anchor" href="#%D1%81%D1%86%D0%B5%D0%BD%D0%B0-%D0%B2%D1%82%D0%BE%D1%80%D0%B0%D1%8F.-%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D1%8B-%D0%B8-%D0%BD%D0%B0%D1%87%D0%B0%D0%BB%D1%8C%D0%BD%D0%B8%D0%BA"><span>Сцена вторая. Документы и начальник</span></a></h2><p>Сергей Базоданнов - суровый начальник и просит не тревожить его просто так, поэтому он попросил Таню отдавтаь документы ему не напрямую, а класть их в специальное место. Таня Ивентлупова исполнительная и никогда не тревожит его, а относит всякие бумажки и забирает подписанные каждый в определенные этапы тика. Тиком Таня называет цикл своего рабочего дня, одним из этапов, которого - это поход в кабинет начальника для того, чтобы оставить ему новые документы и забрать уже подписанные. Вот так вот, во время очередного тика, Таня приняла еще несколько бумажек и пошла к начальнику в кабинет отдать собранные ею за время тика документы. Каждый документ она подписала номером задачи из своего ежедневника.</p><h2 id="%D1%81%D1%86%D0%B5%D0%BD%D0%B0-%D1%82%D1%80%D0%B5%D1%82%D1%8C%D1%8F.-%D0%BA%D0%BE%D0%BB%D0%B1%D0%B5%D0%BA%D0%B8" tabindex="-1"><a class="header-anchor" href="#%D1%81%D1%86%D0%B5%D0%BD%D0%B0-%D1%82%D1%80%D0%B5%D1%82%D1%8C%D1%8F.-%D0%BA%D0%BE%D0%BB%D0%B1%D0%B5%D0%BA%D0%B8"><span>Сцена третья. Колбеки</span></a></h2><p>Начальник Сергей посмотрел анкеты Пети и Вани, принял решение, что берет обоих, написал что-то на анкетах и положил их в папку, которую позже заберет Таня. Таня, следуя своему распорядку дня в виде так называемого ею тика, забрала бумажки, пришла на свое рабочее место и стала разбирать взятые ею документы, сверяясь со своим ежедневником. Дошла очередь и до анкет Пети и Вани. Таня, как и обещала, сделала колбек к каждому из кандидатов и пригласила забрать их свои анкеты с резолюциями начальника. Петя и Ваня Реквестовы на радостях прибежали в компанию, в порядке очереди забрали свои анкеты, после чего радостные пошли смотреть, что им написал Сергей на анкетах.</p><h1 id="%D0%B0%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7-%D1%81%D0%BF%D0%B5%D0%BA%D1%82%D0%B0%D0%BA%D0%BB%D1%8F" tabindex="-1"><a class="header-anchor" href="#%D0%B0%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7-%D1%81%D0%BF%D0%B5%D0%BA%D1%82%D0%B0%D0%BA%D0%BB%D1%8F"><span>Анализ спектакля</span></a></h1><p>Начальник Сергей Базоданнов - это наша база данных, которая работает</p><p>Петя и Ваня Реквестовы - это наши запросы. Каждый из запросов сам по себе является по настоящему асинхронным и независимым так же как и Петя с Ваней.</p><p>Таня Ивентлупова - это наш NodeJS, в основе которого лежит архитектура event-loop. Сам по себе NodeJS работает синхронно, поэтому и все входящие асинхронные запросы он обрабатывает сихнронно, в том порядке, в котором они пришли. Именно из-за этого Таня просила выстроиться в очередь Петю и Ваню т.к. параллельно она не может обрабатывать их анкеты. Более того, чтобы эффективно использовать свое время Таня как и event-loop имеет четкий распорядок дня в виде последовательности действий, которые называются тиком. А самое главное и тут то, что Таня обрабатывает свои задачи порциями в том числе и взаимоействие со своим начальником. А могла бы кажду анкету носить сразу к начальнику, заставив ждать всю очередь, пока она сходит к начальнику, получит решение от начальника и передаст его тому, кто исходно принес анкету.</p><h1 id="%D0%BA%D0%BE%D0%B4!-%D1%81%D0%BD%D0%BE%D0%B2%D0%B0-%D0%BA%D0%BE%D0%B4!" tabindex="-1"><a class="header-anchor" href="#%D0%BA%D0%BE%D0%B4!-%D1%81%D0%BD%D0%BE%D0%B2%D0%B0-%D0%BA%D0%BE%D0%B4!"><span>Код! Снова код!</span></a></h1><p>Теперь посмотрим на код через призму наших персонажей и сцен. В семпле ниже перонаж Таня, олицетворяющая event-loop, сокрыта от нас и действует неявно, но я постараюсь подсветить все моменты.</p><pre><code class="language-javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-title function_">app</span>();

app.<span class="hljs-title function_">get</span>(
  <span class="hljs-string">&#x27;/users/:id&#x27;</span>,
  <span class="hljs-comment">// Тут Таня приняла анкету на обработку</span>
  <span class="hljs-comment">// В данном случае обработка анкеты это три этапа</span>
  <span class="hljs-comment">// 1й - Таня вызвала человека из очереди. По большей части от сокрыт от нас</span>
  <span class="hljs-comment">// 2й - Таня получила анкету, записала задачу в свой ежедневник и пообещала перезвонить. Все эти действия происходят до await</span>
  <span class="hljs-comment">// 3й - Таня получила ответы от начальника и делает звоник (aka callbacks) всем, для кого ответ готов. Все действия после await</span>
  <span class="hljs-keyword">async</span> (req, res) =&gt; {
    <span class="hljs-comment">// тут Таня записывает задачу в свой ежедневник о том, что она работает с какой-то анкетой</span>
    <span class="hljs-comment">// тут же Таня дает обещание (aka Promise) о том, что она оповестит об решении, когда оно поступит</span>
    <span class="hljs-keyword">const</span> form = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Database</span>.<span class="hljs-title function_">reviewAndSignForm</span>(req.<span class="hljs-property">params</span>.<span class="hljs-property">id</span>);

    <span class="hljs-comment">// тут Таня уже всех оповестила (сделала колбеки) и отдает анкеты (вызов res.json)</span>

    res.<span class="hljs-title function_">json</span>({ form });
  }
);

express.<span class="hljs-title function_">listen</span>(<span class="hljs-number">8080</span>);
</code></pre><h1 id="%D0%BE%D1%82%D0%B2%D0%B5%D1%82%D1%8B-%D0%B8-%D0%B2%D1%8B%D0%B2%D0%BE%D0%B4%D1%8B" tabindex="-1"><a class="header-anchor" href="#%D0%BE%D1%82%D0%B2%D0%B5%D1%82%D1%8B-%D0%B8-%D0%B2%D1%8B%D0%B2%D0%BE%D0%B4%D1%8B"><span>Ответы и выводы</span></a></h1><p>Если вы осилили мой графоманский спектакль и его анализ, то теперь можно получить ответы на поставленные вопросы</p><blockquote><p>За какое время выполнится один запрос?</p></blockquote><p>За 100 миллисекунд. В реальности есть всякие разные издержки: сеть может работать не стабильно, задач в очереди может быть много и множество других факторов, но в наших лабораторных условиях будет 100 миллисекунд.</p><blockquote><p>За какое время выпонятся оба запроса?</p></blockquote><p>Так же за 100 миллисекунд. Можно позанудничать на тему того, что задачи в очереди обрабатывались синхронно и суммарное время на обработку двух запросов будет чуть больше 100 миллисекунд.</p><blockquote><p>Почему так происходит?</p></blockquote><p>Потому что NodeJS не блокирует event-loop во время обработки асинхронных задач, вместо этого он запускает асинхронную обработку, регистриурет её и продолжает обрабатывать задачи из тика. В свою очередь, когда асинхронная задача завершается она вызывает колбек, который ей выдал NodeJS и в ближайшем тике NodeJS возьмет задачу в обработку.</p><div>Опубликовано: 1/1/1970</div><div>Ключевые слова: {{tags}}</div><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script></div></div><hr><div class="grid"><div><hgroup><h6>Автор: Арутр Аралин</h6><h6>Telegram: @aaralin, email: username@aaralin.ru</h6></hgroup></div><div style="text-align: right;"><a href="https://github.com/ArturAralin"><kbd>Лайк, подписка, колокольчик</kbd></a></div></div></main></body></html>